generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model OrderOfService {
  id                    String            @id
  pop                   String
  status                String
  uf                    String            @default("")
  dataEntrante          String            @default("")
  dataPrevExec          String            @default("")
  dataConclusao         String            @default("")
  cenario               String            @default("")
  protocolo             String            @default("")
  mes                   String            @default("")
  valorServico          Float             @default(0)
  statusMedicao         String            @default("")
  statusFinal           String            @default("")
  tempo                 String            @default("")
  facilidadesPlanejadas Int               @default(0)
  caixasPlanejadas      Int               @default(0)
  tipoOs                String            @default("")
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  condominio            String?
  descricao             String?
  observacoes           String?
  attachments           OSAttachment[]
  caixas                CaixaAlare[]
  notifications         Notification[]
  execution             ServiceExecution?
  delegations           OSDelegation[]

  @@index([status])
}

model CaixaAlare {
  id         String         @id @default(uuid())
  excelId    String?
  osId       String
  cto        String
  pop        String         @default("")
  cidade     String         @default("")
  uf         String         @default("")
  chassi     String?
  placa      String?
  olt        String?
  cenario    String         @default("")
  bairro     String         @default("")
  endereco   String?
  lat        Float?
  long       Float?
  status     String         @default("Pendente")
  valor      Float          @default(0)
  equipe     String         @default("")
  obs        String         @default("")
  data       String         @default("")
  nomeEquipe String         @default("")
  potencia   String         @default("")
  certified  Boolean        @default(false)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  os         OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)
  photos     Photo[]

  @@index([osId])
}

model LancaAlare {
  id          String   @id @default(uuid())
  excelId     String?
  osId        String?
  de          String   @default("")
  para        String   @default("")
  previsao    String   @default("")
  cenario     String   @default("")
  valor       Float?
  cabo        String   @default("")
  status      String   @default("")
  lancado     String   @default("")
  cenarioReal String   @default("")
  valorReal   Float    @default(0)
  difLanc     Float    @default(0)
  orcadoAtual Float    @default(0)
  data        String?
  equipe      String   @default("")
  descricao   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Equipe {
  id            String             @id @default(uuid())
  excelId       String?            @unique
  codEquipe     String             @default("")
  nomeEquipe    String             @default("")
  name          String             @unique @default("")
  fullName      String?
  password      String             @default("")
  isAdmin       Boolean            @default(false)
  role          String             @default("USER") // ADMIN, SUPERVISOR, USER
  theme         String             @default("system")
  lastUf        String             @default("Todos")
  lastSearch    String             @default("")
  lastStatus    String             @default("Abertas")
  phone         String?
  prestadora    String             @default("")
  classificacao String             @default("")
  unidade       String             @default("")
  descEquipe    String             @default("")
  centro        String             @default("")
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  notifications Notification[]     @relation("EquipeNotifications")
  executions    ServiceExecution[] @relation("EquipeExecutions")
  photos        Photo[]            @relation("EquipePhotos")
  delegations   OSDelegation[]
}

model ServiceExecution {
  id             String         @id @default(uuid())
  osId           String         @unique
  equipeId       String?
  technicianName String?
  status         String         @default("PENDING")
  power          String?
  obs            String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  photos         Photo[]
  equipe         Equipe?        @relation("EquipeExecutions", fields: [equipeId], references: [id])
  os             OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)

  @@index([osId])
}

model Photo {
  id          String            @id @default(uuid())
  executionId String?
  caixaId     String?
  equipeId    String?
  path        String
  createdAt   DateTime          @default(now())
  execution   ServiceExecution? @relation(fields: [executionId], references: [id], onDelete: Cascade)
  equipe      Equipe?           @relation("EquipePhotos", fields: [equipeId], references: [id], onDelete: SetNull)
  caixa       CaixaAlare?       @relation(fields: [caixaId], references: [id], onDelete: Cascade)

  @@index([caixaId])
  @@index([executionId])
}

model Notification {
  id             String          @id @default(uuid())
  type           String
  title          String
  message        String
  read           Boolean         @default(false)
  archived       Boolean         @default(false)
  createdAt      DateTime        @default(now())
  equipeId       String?
  technicianName String?
  osId           String?
  os             OrderOfService? @relation(fields: [osId], references: [id])
  equipe         Equipe?         @relation("EquipeNotifications", fields: [equipeId], references: [id])

  @@index([read, archived, createdAt])
  @@index([equipeId])
}

model OSAttachment {
  id          String         @id @default(uuid())
  osId        String
  name        String
  path        String
  type        String
  size        Int
  createdAt   DateTime       @default(now())
  os          OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)
}

model OSDelegation {
  id          String         @id @default(uuid())
  osId        String
  equipeId    String
  delegatedBy String
  createdAt   DateTime       @default(now())
  os          OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)
  equipe      Equipe         @relation(fields: [equipeId], references: [id], onDelete: Cascade)

  @@unique([osId, equipeId])
  @@index([equipeId])
  @@index([osId])
}
