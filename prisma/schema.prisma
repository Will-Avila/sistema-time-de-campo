generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}


model OrderOfService {
  id            String   @id // Will store the IdOs from Excel
  pop           String
  status        String   // StatusOperacao
  uf            String   @default("")
  dataEntrante  String   @default("")
  dataPrevExec  String   @default("")
  rawPrevExec   Float    @default(0)
  dataConclusao String   @default("")
  rawConclusao  Float    @default(0)
  cenario       String   @default("")
  protocolo     String   @default("")
  mes           String   @default("")
  valorServico  Float    @default(0)
  statusMedicao String   @default("")
  statusFinal   String   @default("")
  tempo         String   @default("")
  facilidadesPlanejadas Int @default(0)
  caixasPlanejadas Int      @default(0)
  tipoOs        String   @default("")
  
  // Relations
  caixas        CaixaAlare[]
  execution     ServiceExecution?
  extraInfo     OSExtraInfo?
  notifications Notification[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
}

model CaixaAlare {
  id          String   @id @default(uuid())
  excelId     String?  // IdCaixa from Excel
  osId        String
  os          OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)
  
  cto         String
  pop         String   @default("")
  cidade      String   @default("")
  uf          String   @default("")
  chassi      String?
  placa       String?
  olt         String?
  cenario     String   @default("")
  bairro      String   @default("")
  endereco    String?
  lat         Float?
  long        Float?
  status      String   @default("Pendente") // OK, Pendente, etc
  valor       Float    @default(0)
  equipe      String   @default("")
  obs         String   @default("")
  data        String   @default("")
  nomeEquipe  String   @default("")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([osId])
}

model LancaAlare {
  id            String   @id @default(uuid())
  excelId       String?  // IdLancamento from Excel
  osId          String?
  de            String   @default("")
  para          String   @default("")
  previsao      String   @default("")
  cenario       String   @default("")
  valor         Float?
  cabo          String   @default("")
  status        String   @default("")
  lancado       String   @default("")
  cenarioReal   String   @default("")
  valorReal     Float    @default(0)
  difLanc       Float    @default(0)
  orcadoAtual   Float    @default(0)
  data          String?
  equipe        String   @default("")
  descricao     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Equipe {
  id            String   @id @default(uuid())
  excelId       String?  @unique // IdEquipe from Excel
  codEquipe     String   @default("")
  nomeEquipe    String   @default("")
  
  // User fields
  name          String   @default("") @unique
  fullName      String?
  password      String   @default("")
  isAdmin       Boolean  @default(false)
  theme         String   @default("system")
  lastUf        String   @default("Todos")
  phone         String?

  prestadora    String   @default("")
  classificacao String   @default("")
  unidade       String   @default("")
  descEquipe    String   @default("")
  centro        String   @default("")

  executions    ServiceExecution[] @relation("EquipeExecutions")
  notifications Notification[] @relation("EquipeNotifications")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServiceExecution {
  id           String      @id @default(uuid())
  osId         String      @unique // One execution per OS
  os           OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)
  
  equipeId     String?
  equipe       Equipe?     @relation("EquipeExecutions", fields: [equipeId], references: [id], onDelete: SetNull)

  technicianName String?   // Archives the name for history even if tech is deleted
  status       String      @default("PENDING") // PENDING, DONE
  power        String?
  obs          String?
  
  photos       Photo[]
  checklist    Checklist[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([osId])
}

model Photo {
  id          String           @id @default(uuid())
  executionId String?
  execution   ServiceExecution? @relation(fields: [executionId], references: [id], onDelete: Cascade)
  checklistId String?
  checklist   Checklist?       @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  path        String
  createdAt   DateTime         @default(now())
}

model Checklist {
  id          String           @id @default(uuid())
  executionId String
  execution   ServiceExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  itemId      String           // Links to item ID (cto or excelId in CaixaAlare)
  done        Boolean          @default(false)
  power       String?          // db/dBm value
  photos      Photo[]

  @@unique([executionId, itemId])
}

model Notification {
  id           String      @id @default(uuid())
  type         String      // CHECKLIST, OS_CLOSE, NEW_OS
  title        String
  message      String
  read         Boolean     @default(false)
  createdAt    DateTime    @default(now())
  
  equipeId     String?
  equipe       Equipe?     @relation("EquipeNotifications", fields: [equipeId], references: [id], onDelete: SetNull)

  technicianName String?   // Archives the name for history even if tech is deleted
  
  osId         String?     
  os           OrderOfService? @relation(fields: [osId], references: [id], onDelete: SetNull)

  @@index([read, createdAt])
}

model OSExtraInfo {
  id          String         @id @default(uuid())
  osId        String         @unique
  os          OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)
  condominio  String?
  descricao   String?
  
  attachments OSAttachment[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model OSAttachment {
  id            String       @id @default(uuid())
  extraInfoId   String
  extraInfo     OSExtraInfo  @relation(fields: [extraInfoId], references: [id], onDelete: Cascade)
  name          String
  path          String
  type          String       // MIME type or extension
  size          Int          // Bytes
  createdAt     DateTime     @default(now())
}
