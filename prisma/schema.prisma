generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Technician {
  id        String   @id @default(uuid())
  name      String   @unique
  fullName  String?
  phone     String?
  password  String
  isAdmin   Boolean  @default(false)
  theme     String   @default("system") // system, light, dark
  lastUf    String   @default("Todos")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  executions    ServiceExecution[]
  notifications Notification[]
}

model OrderOfService {
  id            String   @id // Will store the IdOs from Excel
  pop           String
  status        String   // StatusOperacao
  uf            String   @default("")
  dataEntrante  String   @default("")
  dataPrevExec  String   @default("")
  rawPrevExec   Float    @default(0)
  dataConclusao String   @default("")
  rawConclusao  Float    @default(0)
  cenario       String   @default("")
  protocolo     String   @default("")
  
  // Relations
  caixas        CaixaAlare[]
  execution     ServiceExecution?
  extraInfo     OSExtraInfo?
  notifications Notification[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
}

model CaixaAlare {
  id          String   @id @default(uuid())
  excelId     String?  // IdCaixa from Excel
  osId        String
  os          OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)
  
  cto         String
  chassi      String?
  placa       String?
  olt         String?
  endereco    String?
  lat         Float?
  long        Float?
  status      String   @default("Pendente") // OK, Pendente, etc

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([osId])
}

model LancaAlare {
  id        String   @id @default(uuid())
  excelId   String?  // IdLanca from Excel
  osId      String?
  data      String?
  valor     Float?
  descricao String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServiceExecution {
  id           String      @id @default(uuid())
  osId         String      @unique // One execution per OS
  os           OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)
  technicianId String?
  technician   Technician? @relation(fields: [technicianId], references: [id], onDelete: SetNull)
  technicianName String?   // Archives the name for history even if tech is deleted
  status       String      @default("PENDING") // PENDING, DONE
  power        String?
  obs          String?
  
  photos       Photo[]
  checklist    Checklist[]

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([osId])
}

model Photo {
  id          String           @id @default(uuid())
  executionId String?
  execution   ServiceExecution? @relation(fields: [executionId], references: [id], onDelete: Cascade)
  checklistId String?
  checklist   Checklist?       @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  path        String
  createdAt   DateTime         @default(now())
}

model Checklist {
  id          String           @id @default(uuid())
  executionId String
  execution   ServiceExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  itemId      String           // Links to item ID (cto or excelId in CaixaAlare)
  done        Boolean          @default(false)
  power       String?          // db/dBm value
  photos      Photo[]

  @@unique([executionId, itemId])
}

model Notification {
  id           String      @id @default(uuid())
  type         String      // CHECKLIST, OS_CLOSE, NEW_OS
  title        String
  message      String
  read         Boolean     @default(false)
  createdAt    DateTime    @default(now())
  
  technicianId String?
  technician   Technician? @relation(fields: [technicianId], references: [id], onDelete: SetNull)
  technicianName String?   // Archives the name for history even if tech is deleted
  
  osId         String?     
  os           OrderOfService? @relation(fields: [osId], references: [id], onDelete: SetNull)

  @@index([read, createdAt])
}

model OSExtraInfo {
  id          String         @id @default(uuid())
  osId        String         @unique
  os          OrderOfService @relation(fields: [osId], references: [id], onDelete: Cascade)
  condominio  String?
  descricao   String?
  
  attachments OSAttachment[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model OSAttachment {
  id            String       @id @default(uuid())
  extraInfoId   String
  extraInfo     OSExtraInfo  @relation(fields: [extraInfoId], references: [id], onDelete: Cascade)
  name          String
  path          String
  type          String       // MIME type or extension
  size          Int          // Bytes
  createdAt     DateTime     @default(now())
}
