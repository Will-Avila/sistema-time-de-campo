"use strict";exports.id=213,exports.ids=[213],exports.modules={357:(e,a,t)=>{t.d(a,{XP:()=>d,ck:()=>r,ex:()=>i,jt:()=>o,kj:()=>n}),t(13664);var s=t(28371),r=(0,s.$)("bb9004a81e2ec4420b2b97debd5f27e567e92ef6"),i=(0,s.$)("c5f7132601121f48314d1a51ecac279117f08ff6"),o=(0,s.$)("3a7a815bcde402ec80a76d4915ddaa24dd2697a6"),d=(0,s.$)("c98ca564b4813ac5836f5e16d8b41e62d1cf9860"),n=(0,s.$)("e0bf2b8da39f29f7764053adebc46527dec3237e");(0,s.$)("2dd604a4fa171d5bf4edd119607f12882f2f1233")},85740:(e,a,t)=>{t.r(a),t.d(a,{Header:()=>S});var s=t(95344),r=t(3729),i=t(18822),o=t(98200),d=t(98714),n=t(47180),c=t(23425),l=t(2273),m=t(48120),u=t(5094),f=t(12998),p=t(357),x=t(56506),h=t(99558),b=t(8428),g=t(33037),v=t(62312);t(13664);var y=t(28371),w=(0,y.$)("a097c09bcedad3830c63ef8bf1297807d0616abc");(0,y.$)("22c53d6cc54bce46a621cc2c18c29a4b6151f7eb");var N=(0,y.$)("84b4112fe213bb4e51d524390b924583a28cf4a6"),j=(0,y.$)("531833ed2258d48c2a40d41cd7d226d4ccc024cc");function k(){let[e,a]=(0,r.useState)([]),[t,i]=(0,r.useState)(!1),[o,d]=(0,r.useState)(!0),n=(0,b.useRouter)(),c=async()=>{a(await N()),d(!1)};(0,r.useEffect)(()=>{c();let e=setInterval(c,3e4);return()=>clearInterval(e)},[]);let l=async e=>{a(a=>a.filter(a=>a.id!==e)),await j(e)},m=async()=>{let t=[...e];a([]),(await w()).success||a(t),i(!1)},f=e.length;return(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsxs)(u.z,{variant:"ghost",size:"icon",className:"relative text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800",onClick:()=>i(!t),children:[s.jsx(g.Z,{className:"h-5 w-5"}),f>0&&s.jsx("span",{className:"absolute top-2 right-2 h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white dark:ring-slate-950 animate-pulse"})]}),t&&(0,s.jsxs)(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>i(!1)}),(0,s.jsxs)("div",{className:"absolute right-0 top-12 w-80 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 shadow-xl rounded-lg overflow-hidden z-50 animate-in fade-in zoom-in-95 duration-200",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 border-b dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/50",children:[s.jsx("h4",{className:"font-semibold text-sm text-slate-900 dark:text-slate-100",children:"Notifica\xe7\xf5es"}),f>0&&s.jsx("button",{className:"text-xs text-primary hover:opacity-80 font-medium transition-colors",onClick:m,children:"Marcar todas como lidas"})]}),s.jsx("div",{className:"max-h-[300px] overflow-y-auto custom-scrollbar",children:o&&0===e.length?(0,s.jsxs)("div",{className:"p-8 text-center",children:[s.jsx("div",{className:"animate-spin h-5 w-5 border-2 border-slate-300 border-t-primary rounded-full mx-auto mb-2"}),s.jsx("p",{className:"text-xs text-slate-500",children:"Carregando..."})]}):0===e.length?(0,s.jsxs)("div",{className:"p-12 text-center text-slate-500",children:[s.jsx(g.Z,{className:"h-8 w-8 mx-auto mb-3 opacity-20"}),s.jsx("p",{className:"text-sm",children:"Nenhuma notifica\xe7\xe3o nova"})]}):s.jsx("div",{className:"divide-y divide-slate-100 dark:divide-slate-800",children:e.map(e=>s.jsx("div",{onClick:()=>{e.osId&&(l(e.id),n.push(`/os/${e.osId}`),i(!1))},className:`p-4 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors relative group ${e.osId?"cursor-pointer":""}`,children:(0,s.jsxs)("div",{className:"flex gap-3",children:[s.jsx("div",{className:`mt-1.5 h-2 w-2 rounded-full shrink-0 ${"OS_CLOSE"===e.type?"bg-blue-500":"NEW_OS"===e.type?"bg-emerald-500":"bg-amber-500"}`}),(0,s.jsxs)("div",{className:"flex-1 space-y-1",children:[s.jsx("p",{className:"text-sm font-medium leading-none text-slate-900 dark:text-slate-100",children:e.title}),s.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 line-clamp-2 leading-relaxed",children:e.message}),s.jsx("p",{className:"text-[10px] text-slate-400 font-medium",children:function(e){let a=new Date,t=new Date(e),s=Math.floor((a.getTime()-t.getTime())/1e3);if(s<60)return"agora mesmo";let r=Math.floor(s/60);if(r<60)return`h\xe1 ${r} min`;let i=Math.floor(r/60);if(i<24)return`h\xe1 ${i}h`;let o=Math.floor(i/24);return o<7?`h\xe1 ${o}d`:t.toLocaleDateString("pt-BR")}(e.createdAt)})]}),s.jsx("button",{className:"h-6 w-6 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 hover:text-primary transition-colors opacity-0 group-hover:opacity-100",onClick:a=>{a.stopPropagation(),l(e.id)},title:"Marcar como lida",children:s.jsx(v.Z,{className:"h-3 w-3"})})]})},e.id))})})]})]})]})}function S({username:e,initialTheme:a,isAdmin:t}){let[b,g]=(0,r.useState)(!1),{theme:v,setTheme:y}=(0,h.F)(),[w,N]=(0,r.useState)(!1),j=e.split(" ")[0];async function S(){let e="dark"===v?"light":"dark";y(e),await (0,p.ex)("theme",e)}return(0,r.useEffect)(()=>{N(!0),a&&y(a)},[a,y]),(0,s.jsxs)("header",{className:"fixed top-0 left-0 right-0 h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 shadow-sm z-50 px-4 flex items-center justify-between transition-colors",children:[s.jsx("div",{className:"flex-1",children:s.jsx(x.default,{href:"/os",className:"text-xl font-bold tracking-tighter text-primary",children:"X-ON"})}),(0,s.jsxs)("div",{className:"flex items-center gap-2 text-slate-700 dark:text-slate-200",children:[(0,s.jsxs)("span",{className:"font-medium text-sm hidden md:inline-block",children:["Ol\xe1, ",j]}),s.jsx("span",{className:"font-medium text-sm md:hidden",children:j}),s.jsx("div",{className:"bg-primary/10 dark:bg-primary/20 p-1.5 rounded-full text-primary",children:s.jsx(i.Z,{className:"h-4 w-4"})})]}),(0,s.jsxs)("div",{className:"flex-1 flex justify-end items-center gap-2 relative",children:[s.jsx(k,{}),s.jsx(u.z,{variant:"ghost",size:"icon",onClick:()=>g(!b),className:"text-slate-600 dark:text-slate-300 hover:text-primary hover:bg-primary/10",children:s.jsx(o.Z,{className:"h-6 w-6"})}),b&&(0,s.jsxs)("div",{className:"absolute top-12 right-0 w-52 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 shadow-lg rounded-lg overflow-hidden animate-in fade-in slide-in-from-top-2 p-1",children:[(0,s.jsxs)("button",{type:"button",onClick:S,className:"w-full flex items-center gap-2 px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md transition-colors text-left",children:[w?"dark"===v?s.jsx(d.Z,{className:"h-4 w-4 text-amber-500"}):s.jsx(n.Z,{className:"h-4 w-4 text-indigo-500"}):s.jsx("div",{className:"h-4 w-4 animate-pulse bg-slate-200 dark:bg-slate-700 rounded-full"}),w?"dark"===v?"Modo Claro":"Modo Escuro":"Carregando..."]}),s.jsx("div",{className:"border-t border-slate-100 dark:border-slate-700 my-1"}),(0,s.jsxs)(x.default,{href:"/os",className:"w-full flex items-center gap-2 px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md transition-colors",onClick:()=>g(!1),children:[s.jsx(c.Z,{className:"h-4 w-4 text-blue-600"}),"Ordens de Servi\xe7o"]}),t&&(0,s.jsxs)(s.Fragment,{children:[s.jsx("div",{className:"border-t border-slate-100 dark:border-slate-700 my-1"}),(0,s.jsxs)(x.default,{href:"/admin/dashboard",className:"w-full flex items-center gap-2 px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md transition-colors",onClick:()=>g(!1),children:[s.jsx(l.Z,{className:"h-4 w-4 text-primary"}),"Dashboard"]})]}),s.jsx("div",{className:"border-t border-slate-100 dark:border-slate-700 my-1"}),(0,s.jsxs)(x.default,{href:"/profile",className:"w-full flex items-center gap-2 px-4 py-2.5 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-md transition-colors",onClick:()=>g(!1),children:[s.jsx(i.Z,{className:"h-4 w-4 text-slate-500 dark:text-slate-400"}),"Editar Perfil"]}),s.jsx("div",{className:"border-t border-slate-100 dark:border-slate-700 my-1"}),s.jsx("form",{action:async()=>{await (0,f.k)()},children:(0,s.jsxs)("button",{type:"submit",className:"w-full flex items-center gap-2 px-4 py-2.5 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors text-left",children:[s.jsx(m.Z,{className:"h-4 w-4"}),"Sair"]})})]})]}),b&&s.jsx("div",{className:"fixed inset-0 z-[-1]",onClick:()=>g(!1)})]})}},36051:(e,a,t)=>{t.r(a),t.d(a,{createNotification:()=>m,getUnreadNotifications:()=>f,markAllAsRead:()=>x,markAsRead:()=>p});var s=t(98601);t(75811);var r=t(50841),i=t(43811),o=t(68474),d=t(19961),n=t(69260),c=t(46893);let l=0;async function m(e){try{return d.logger.info("Creating notification",{type:e.type,title:e.title}),await r.prisma.notification.create({data:{...e,read:!1,type:e.type}}),{success:!0}}catch(e){return d.logger.error("Error creating notification",{error:String(e)}),{success:!1}}}async function u(){let e=Date.now();if(!(e-l<6e4)){l=e;try{let e=await (0,n.getAllOS)();if(0===e.length)return;let a=await r.prisma.notification.findMany({where:{type:"NEW_OS",osId:{not:null}},select:{osId:!0},distinct:["osId"]}),t=new Set(a.map(e=>e.osId)),s=e.filter(e=>!t.has(e.id));if(0===s.length)return;d.logger.info(`Found ${s.length} new OSs to notify.`);let i=await r.prisma.equipe.findMany({select:{id:!0}});for(let e of s){let a=e.protocolo||e.id,t=`A OS ${a} foi adicionada em ${e.uf}, prazo ${e.dataPrevExec}`,s=i.map(a=>({type:"NEW_OS",title:"Nova Ordem de Servi\xe7o",message:t,read:!1,osId:e.id,equipeId:a.id,createdAt:new Date}));await r.prisma.notification.createMany({data:s})}}catch(e){d.logger.error("Error syncing new OS notifications",{error:String(e)})}}}async function f(){let e=await (0,o.getSession)();if(!e)return[];await u();try{let a={read:!1};return e.isAdmin?a.OR=[{type:{in:["CHECKLIST","OS_CLOSE"]}},{type:"NEW_OS",equipeId:e.id}]:(a.type="NEW_OS",a.equipeId=e.id),await r.prisma.notification.findMany({where:a,orderBy:{createdAt:"desc"},take:20,include:{equipe:{select:{name:!0,fullName:!0,nomeEquipe:!0}}}})}catch(e){return d.logger.error("Error fetching notifications",{error:String(e)}),[]}}async function p(e){let a=await (0,o.getSession)();if(!a)return{success:!1,message:"N\xe3o autorizado."};try{let t=await r.prisma.notification.findUnique({where:{id:e}});if(!t)return{success:!1,message:"N\xe3o encontrada."};let s=["CHECKLIST","OS_CLOSE"].includes(t.type),o=t.equipeId===a.id;if(s){if(!a.isAdmin)return{success:!1,message:"N\xe3o autorizado."}}else if(!o)return{success:!1,message:"N\xe3o autorizado."};return await r.prisma.notification.update({where:{id:e},data:{read:!0}}),(0,i.revalidatePath)("/admin"),(0,i.revalidatePath)("/os"),{success:!0}}catch(e){return{success:!1,message:"Erro ao marcar notifica\xe7\xe3o."}}}async function x(){let e=await (0,o.getSession)();if(!e)return{success:!1,message:"N\xe3o autorizado."};try{let a={read:!1};return e.isAdmin?a.OR=[{type:{in:["CHECKLIST","OS_CLOSE"]}},{type:"NEW_OS",equipeId:e.id}]:(a.type="NEW_OS",a.equipeId=e.id),await r.prisma.notification.updateMany({where:a,data:{read:!0}}),(0,i.revalidatePath)("/admin"),(0,i.revalidatePath)("/os"),{success:!0}}catch(e){return{success:!1,message:"Erro ao marcar notifica\xe7\xf5es."}}}(0,c.ensureServerEntryExports)([m,f,p,x]),(0,s.createActionProxy)("22c53d6cc54bce46a621cc2c18c29a4b6151f7eb",m),(0,s.createActionProxy)("84b4112fe213bb4e51d524390b924583a28cf4a6",f),(0,s.createActionProxy)("531833ed2258d48c2a40d41cd7d226d4ccc024cc",p),(0,s.createActionProxy)("a097c09bcedad3830c63ef8bf1297807d0616abc",x)},74801:(e,a,t)=>{t.d(a,{c:()=>m});var s=t(25036),r=t(81494),i=t(86843);let o=(0,i.createProxy)(String.raw`C:\Programas\PROJETOS\sistema-time-de-campo\src\components\layout\Header.tsx`),{__esModule:d,$$typeof:n}=o;o.default;let c=(0,i.createProxy)(String.raw`C:\Programas\PROJETOS\sistema-time-de-campo\src\components\layout\Header.tsx#Header`);var l=t(55379);async function m(){let e=await (0,l.getSession)(),a="Usu\xe1rio",t="light",i=!1;if(e){a=e.username,i=e.isAdmin;let s=await r._.equipe.findUnique({where:{id:e.id},select:{theme:!0,fullName:!0,name:!0,nomeEquipe:!0}});s&&(t=s.theme||"light",(s.fullName||s.nomeEquipe)&&(a=s.fullName||s.nomeEquipe||s.name))}return s.jsx(c,{username:a,initialTheme:t,isAdmin:i})}},55379:(e,a,t)=>{t.r(a),t.d(a,{clearSessionCookie:()=>p,createToken:()=>u,getSession:()=>c,requireAdmin:()=>m,requireAuth:()=>l,setSessionCookie:()=>f});var s=t(74471);t(68616);var r=t(7439),i=t(31865),o=t(79616);let d=process.env.JWT_SECRET;if(!d)throw Error("A vari\xe1vel de ambiente JWT_SECRET \xe9 obrigat\xf3ria.");let n=new TextEncoder().encode(d);async function c(){let e=r.cookies().get("session")?.value;if(!e)return null;try{let{payload:a}=await (0,i._)(e,n);return{id:a.sub,username:a.username,isAdmin:!!a.isAdmin}}catch{return null}}async function l(){let e=await c();if(!e)throw Error("N\xe3o autenticado.");return e}async function m(){let e=await l();if(!e.isAdmin)throw Error("Acesso n\xe3o autorizado.");return e}async function u(e){return new o.N({sub:e.id,username:e.username,isAdmin:e.isAdmin}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("24h").sign(n)}async function f(e){(0,r.cookies)().set("session",e,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:86400})}async function p(){(0,r.cookies)().delete("session")}(0,t(42053).h)([c,l,m,u,f,p]),(0,s.U)("01aa194246fb3cd3909854170a6a003e66db9b89",c),(0,s.U)("7f6832b04b751148a6382dd64a1cc223449e53b3",l),(0,s.U)("8d8f3bd62d0a07b2792f9104701a5c0433fbcdee",m),(0,s.U)("bbad0871288a94d710af6fbd6788ce5f0465e0e3",u),(0,s.U)("bdb6b21ecc9aab6757183c887af3cd3c576bd3b3",f),(0,s.U)("6025ca35376357c0da7f5b807633b24af797ac4b",p)},81494:(e,a,t)=>{t.d(a,{_:()=>r});var s=t(53524);let r=global.prisma||new s.PrismaClient},69260:(e,a,t)=>{t.d(a,{getAllOS:()=>r,getOSById:()=>i,invalidateExcelCache:()=>o});var s=t(50841);async function r(){return(await s.prisma.orderOfService.findMany({include:{caixas:{select:{id:!0}},attachments:!0},orderBy:{pop:"asc"}})).map(e=>({id:e.id,pop:e.pop,status:e.status,uf:e.uf,dataEntrante:e.dataEntrante,dataPrevExec:e.dataPrevExec,dataConclusao:e.dataConclusao,mes:e.mes,valorServico:e.valorServico,statusMedicao:e.statusMedicao,statusFinal:e.statusFinal,tempo:e.tempo,facilidadesPlanejadas:e.facilidadesPlanejadas,caixasPlanejadas:e.caixasPlanejadas,tipoOs:e.tipoOs,cenario:e.cenario,protocolo:e.protocolo,totalCaixas:e.caixas.length,condominio:e.condominio||void 0,descricao:e.descricao||void 0,anexos:e.attachments.map(e=>({id:e.id,name:e.name,path:e.path,size:e.size,type:e.type}))}))}async function i(e){let a=await s.prisma.orderOfService.findFirst({where:{OR:[{id:e},{pop:e}]},include:{caixas:{include:{photos:!0}},attachments:!0}});if(!a)return null;let t=await s.prisma.equipe.findMany({select:{id:!0,fullName:!0,nomeEquipe:!0,name:!0}}),r=new Map;t.forEach(e=>{r.set(e.id,e.fullName||e.nomeEquipe||e.name)});let i=a.caixas.map(e=>{let t=[];t.push(a.pop),e.chassi&&t.push(e.chassi),e.placa&&t.push(e.placa),e.olt&&t.push(e.olt),t.push(e.cto);let s=e.equipe&&r.get(e.equipe)||e.nomeEquipe;return{id:e.id,cto:e.cto,pop:e.pop,cidade:e.cidade,uf:e.uf,chassi:e.chassi||void 0,placa:e.placa||void 0,olt:e.olt||void 0,cenario:e.cenario,bairro:e.bairro,chassiPath:t.filter(Boolean).join("/"),endereco:e.endereco||"",lat:e.lat,long:e.long,status:e.status,valor:e.valor,equipe:e.equipe,obs:e.obs,data:e.data,nomeEquipe:s,potencia:e.potencia,done:"OK"===e.status,certified:e.certified,photos:e.photos.map(e=>({id:e.id,path:e.path,equipeId:e.equipeId}))}});return{id:a.id,pop:a.pop,status:a.status,protocolo:a.protocolo,uf:a.uf,dataEntrante:a.dataEntrante,dataPrevExec:a.dataPrevExec,dataConclusao:a.dataConclusao,mes:a.mes,valorServico:a.valorServico,statusMedicao:a.statusMedicao,statusFinal:a.statusFinal,tempo:a.tempo,facilidadesPlanejadas:a.facilidadesPlanejadas,caixasPlanejadas:a.caixasPlanejadas,tipoOs:a.tipoOs,cenario:a.cenario,totalCaixas:i.length,items:i,condominio:a.condominio||void 0,descricao:a.descricao||void 0,anexos:a.attachments.map(e=>({id:e.id,name:e.name,path:e.path,size:e.size,type:e.type}))}}function o(){}}};